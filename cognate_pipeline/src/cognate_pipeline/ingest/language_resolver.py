"""Resolve language identifiers to Glottocodes."""

from __future__ import annotations

import json
import logging
from pathlib import Path
from typing import Any

from cognate_pipeline.utils.glottolog import GlottologTree

logger = logging.getLogger(__name__)

# Load language map from JSON (generated by scripts/convert_cldf_to_tsv.py).
# Falls back to a minimal hardcoded map if the JSON is missing.
_LANGUAGE_MAP_PATH = Path(__file__).parent / "language_map.json"

_HARDCODED_FALLBACK: dict[str, str] = {
    "uga": "ugar1238", "heb": "hebr1245", "got": "goth1244", "xib": "iber1250",
    "akk": "akka1240", "sux": "sume1241", "lat": "lati1261", "grc": "anci1242",
    "arc": "offi1241", "egy": "egyp1253", "hit": "hitt1242", "phn": "phoe1239",
    "syc": "clas1252", "eus": "basq1248",
    "ang": "olde1238", "non": "oldn1244", "goh": "oldh1241",
    "sga": "oldi1245", "cym": "wels1247", "bre": "bret1244",
    "lit": "lith1251", "chu": "chur1257", "rus": "russ1263",
    "san": "sans1269", "ave": "aves1237", "fas": "west2369",
    "osc": "osca1245", "xum": "umbr1253", "gmy": "myce1241",
    "arb": "stan1318", "amh": "amha1245",
    "otk": "oldt1247", "tur": "nucl1301", "aze": "nort2697",
    "fin": "finn1318", "hun": "hung1274", "est": "esto1258",
}

if _LANGUAGE_MAP_PATH.exists():
    with open(_LANGUAGE_MAP_PATH, encoding="utf-8") as _f:
        _HARDCODED: dict[str, str] = json.load(_f)
    logger.debug("Loaded %d language mappings from %s", len(_HARDCODED), _LANGUAGE_MAP_PATH)
else:
    _HARDCODED = _HARDCODED_FALLBACK
    logger.debug("Using fallback language map (%d entries)", len(_HARDCODED))


class LanguageResolver:
    """Resolve language identifiers to Glottocodes.

    Resolution chain:
    1. Direct Glottocode (4-char alpha + 4-digit pattern)
    2. Hardcoded ancient language mappings
    3. Glottolog tree lookup (by code, ISO-639-3, or name)
    """

    def __init__(self, glottolog_tree: GlottologTree | None = None) -> None:
        self._tree = glottolog_tree

    def resolve(self, identifier: str) -> str:
        """Return a Glottocode for the given identifier, or '' if unresolved."""
        identifier = identifier.strip()
        if not identifier:
            return ""

        # Check if it's already a Glottocode pattern (xxxx1234)
        if len(identifier) == 8 and identifier[:4].isalpha() and identifier[4:].isdigit():
            return identifier

        # Hardcoded mappings
        if identifier.lower() in _HARDCODED:
            return _HARDCODED[identifier.lower()]

        # Glottolog tree lookup
        if self._tree is not None:
            lang = self._tree.lookup(identifier)
            if lang is not None:
                return lang.glottocode

        logger.debug("Could not resolve language identifier: %s", identifier)
        return ""
